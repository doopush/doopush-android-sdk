name: Auto Build and Release

on:
  push:
    branches:
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  AAR_NAME: DooPushSDK

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸åˆ›å»ºæ ‡ç­¾å’Œå‘å¸ƒ
      packages: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ç”¨äºç‰ˆæœ¬æ£€æµ‹
          
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            build
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/build.gradle', '**/gradle.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
            
      - name: Extract version from build.gradle
        id: version
        run: |
          echo "ğŸ” å¼€å§‹æå–ç‰ˆæœ¬å·..."

          BUILD_GRADLE_PATH="lib/build.gradle"
          if [ -f "$BUILD_GRADLE_PATH" ]; then
            echo "âœ… æ‰¾åˆ° $BUILD_GRADLE_PATH æ–‡ä»¶"

            # æ˜¾ç¤ºç‰ˆæœ¬ç›¸å…³è¡Œç”¨äºè°ƒè¯•
            echo "ğŸ“‹ build.gradle ç‰ˆæœ¬è¡Œ:"
            grep -n "version\|SDK_VERSION" "$BUILD_GRADLE_PATH" || echo "æœªæ‰¾åˆ° version è¡Œ"

            # ä¼˜å…ˆä» publishing.version æå–ç‰ˆæœ¬å·
            VERSION=$(grep -E "^\s*version\s*=\s*['\"][^'\"]+['\"]" "$BUILD_GRADLE_PATH" | grep -oE "[0-9]+\.[0-9]+\.[0-9]+" | head -1)
            
            # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•ä» SDK_VERSION æå–
            if [ -z "$VERSION" ]; then
              VERSION=$(grep -E "SDK_VERSION.*['\"][^'\"]*['\"]" "$BUILD_GRADLE_PATH" | grep -oE "[0-9]+\.[0-9]+\.[0-9]+" | head -1)
            fi

            if [ ! -z "$VERSION" ]; then
              echo "âœ… æ£€æµ‹åˆ°ç‰ˆæœ¬: $VERSION"
              echo "version=$VERSION" >> $GITHUB_OUTPUT
            else
              echo "âŒ æœªèƒ½æå–ç‰ˆæœ¬å·"
              echo "ğŸ“‹ build.gradle æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
              head -30 "$BUILD_GRADLE_PATH"
              exit 1
            fi
          else
            echo "âŒ æ‰¾ä¸åˆ° $BUILD_GRADLE_PATH æ–‡ä»¶"
            echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi
          
      - name: Check if release exists
        id: check_release
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if gh release view "v$VERSION" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ ç‰ˆæœ¬ v$VERSION çš„ Release å·²å­˜åœ¨ï¼Œå°†åˆ é™¤åé‡æ–°å‘å¸ƒ"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… ç‰ˆæœ¬ v$VERSION æ˜¯æ–°ç‰ˆæœ¬ï¼Œå°†åˆ›å»º Release"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up existing release and tag
        if: steps.check_release.outputs.exists == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "ğŸ§¹ æ¸…ç†ç°æœ‰ç‰ˆæœ¬: v$VERSION"

          # åˆ é™¤ç°æœ‰çš„ Release
          echo "åˆ é™¤ Release..."
          gh release delete "v$VERSION" --yes || echo "Release åˆ é™¤å¤±è´¥æˆ–ä¸å­˜åœ¨"

          # åˆ é™¤æœ¬åœ°å’Œè¿œç¨‹æ ‡ç­¾
          echo "åˆ é™¤ Git æ ‡ç­¾..."
          git tag -d "v$VERSION" 2>/dev/null || echo "æœ¬åœ°æ ‡ç­¾ä¸å­˜åœ¨"
          git push origin :refs/tags/"v$VERSION" 2>/dev/null || echo "è¿œç¨‹æ ‡ç­¾åˆ é™¤å¤±è´¥æˆ–ä¸å­˜åœ¨"

          echo "âœ… æ¸…ç†å®Œæˆï¼Œç»§ç»­å‘å¸ƒæ–°ç‰ˆæœ¬"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Grant execute permission to gradlew
        run: chmod +x gradlew
        
      - name: Build AAR
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»º AAR..."
          
          # æ¸…ç†ä¹‹å‰çš„æ„å»º
          ./gradlew clean
          
          # æ„å»º Release AAR
          if ./gradlew :lib:assembleRelease; then
            echo "âœ… AAR æ„å»ºæˆåŠŸ"
          else
            echo "âŒ AAR æ„å»ºå¤±è´¥"
            exit 1
          fi
          
      - name: Verify AAR
        run: |
          AAR_PATH="lib/build/outputs/aar"
          if [ -d "$AAR_PATH" ]; then
            echo "âœ… AAR æ„å»ºæˆåŠŸ"
            echo "ğŸ“Š AAR æ–‡ä»¶ä¿¡æ¯:"
            ls -la "$AAR_PATH"
            
            # æŸ¥æ‰¾ release AAR æ–‡ä»¶
            RELEASE_AAR=$(find "$AAR_PATH" -name "*-release.aar" | head -1)
            if [ ! -z "$RELEASE_AAR" ]; then
              echo "ğŸ“¦ æ‰¾åˆ° Release AAR: $RELEASE_AAR"
              # é‡å‘½åä¸ºç»Ÿä¸€æ ¼å¼
              cp "$RELEASE_AAR" "$AAR_PATH/${AAR_NAME}.aar"
              echo "ğŸ“¦ é‡å‘½åä¸º: ${AAR_NAME}.aar"
            else
              echo "âŒ æœªæ‰¾åˆ° Release AAR æ–‡ä»¶"
              exit 1
            fi
          else
            echo "âŒ AAR æ„å»ºå¤±è´¥"
            exit 1
          fi
          
      - name: Generate Release Notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # è·å–æœ€è¿‘çš„æäº¤è®°å½•
          if git tag | grep -q "v"; then
            LAST_TAG=$(git tag | grep "^v" | sort -V | tail -1)
            COMMITS=$(git log --oneline --no-merges "${LAST_TAG}..HEAD" | head -10)
          else
            COMMITS=$(git log --oneline --no-merges | head -10)
          fi
          
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          cat > release_notes.md << EOF
          ## DooPushSDK v${VERSION}
          
          ### ğŸ“± Android SDK ä¿¡æ¯
          - **æœ€ä½æ”¯æŒ**: Android API 21 (5.0)+
          - **ç¼–è¯‘ç‰ˆæœ¬**: Android API 34
          - **Java ç‰ˆæœ¬**: 8+
          - **Kotlin ç‰ˆæœ¬**: 1.8+
          
          ### ğŸ“¦ é›†æˆæ–¹å¼
          
          ä¸‹è½½ \`DooPushSDK.aar\` æ–‡ä»¶ï¼Œé›†æˆåˆ°æ‚¨çš„ Android é¡¹ç›®ä¸­ã€‚
          
          è¯¦ç»†é›†æˆæ­¥éª¤ã€å‚å•†æ¨é€æ”¯æŒå’Œé…ç½®è¯´æ˜è¯·æŸ¥çœ‹å®Œæ•´çš„ [Android é›†æˆæŒ‡å—](https://docs.doopush.com/sdk/android-integration)ã€‚
          
          ### ğŸ”— ç›¸å…³é“¾æ¥
          - [æ–‡æ¡£](https://doopush.com/docs)
          - [é›†æˆæŒ‡å—](https://doopush.com/docs/sdk/android-integration)
          - [ç¤ºä¾‹é¡¹ç›®](https://github.com/doopush/doopush/tree/main/sdk/android/DooPushSDKExample)
          EOF
          
          echo "release_notes_file=release_notes.md" >> $GITHUB_OUTPUT
          
      - name: Create Git Tag
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "ğŸ·ï¸ åˆ›å»º Git æ ‡ç­¾: v$VERSION"
          git config user.name "DooPush Bot"
          git config user.email "bot@doopush.com"
          git tag "v$VERSION"
          git push origin "v$VERSION"
          echo "âœ… Git æ ‡ç­¾åˆ›å»ºæˆåŠŸ"

      - name: Create GitHub Release
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RELEASE_NOTES_FILE="${{ steps.release_notes.outputs.release_notes_file }}"

          echo "ğŸ‰ åˆ›å»º Release: DooPushSDK v$VERSION"

          # ç­‰å¾…ä¸€ç§’ç¡®ä¿æ ‡ç­¾å·²åŒæ­¥
          sleep 2

          # ä½¿ç”¨ GitHub CLI åˆ›å»º release å¹¶ä¸Šä¼ æ–‡ä»¶
          gh release create "v$VERSION" \
            --title "DooPushSDK v$VERSION" \
            --notes-file "$RELEASE_NOTES_FILE" \
            --draft=false \
            --prerelease=false \
            "lib/build/outputs/aar/${{ env.AAR_NAME }}.aar" \
            "lib/build.gradle"

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [ "${{ steps.check_release.outputs.exists }}" = "true" ]; then
            echo "ğŸ”„ DooPushSDK v$VERSION é‡æ–°å‘å¸ƒæˆåŠŸ!"
            echo "ğŸ“¦ åˆ é™¤äº†æ—§ç‰ˆæœ¬ï¼Œåˆ›å»ºäº†æ–°ç‰ˆæœ¬"
          else
            echo "ğŸ‰ DooPushSDK v$VERSION æ–°ç‰ˆæœ¬å‘å¸ƒæˆåŠŸ!"
          fi
          echo "ğŸ“¦ Release URL: https://github.com/doopush/doopush-android-sdk/releases/tag/v$VERSION"
          echo "ğŸ“± AAR æ–‡ä»¶: DooPushSDK.aar"
          echo "ğŸ“„ Build æ–‡ä»¶: build.gradle"
